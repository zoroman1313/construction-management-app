<!DOCTYPE html>
<html lang="en-GB" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ff8c42">
    <meta name="msapplication-navbutton-color" content="#ff8c42">
    <title>Contractors - Construction Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/auth.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-building"></i>
                <span>Building</span>
            </div>
            
            <!-- User Profile Section -->
            <div class="user-profile" id="userProfile" style="display: none;">
                <div class="user-info">
                    <img src="../images/default-avatar.svg" alt="Profile photo" class="user-avatar" id="userAvatar">
                    <span class="user-name" id="userName">User</span>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
            
            <!-- Auth Button -->
            <div class="auth-section" id="authSection">
                <button id="authBtn" class="auth-btn">
                    <i class="fas fa-user"></i>
                    <span id="authText">Sign in</span>
                </button>
            </div>
            
            <nav class="nav">
                <ul class="nav-list">
                    <li><a href="../index.html" class="nav-link"><i class="fas fa-home"></i></a></li>
                    <li><a href="users.html" class="nav-link"><i class="fas fa-users"></i></a></li>
                    <li><a href="#" class="nav-link active"><i class="fas fa-hard-hat"></i></a></li>
                    <li><a href="providers.html" class="nav-link"><i class="fas fa-handshake"></i></a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <div class="page-header">
                <button class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back</span>
                </button>
                <h1 class="page-title">Contractor Services</h1>
            </div>
            
            <p class="page-subtitle">Reports, Estimates, Ongoing & New Projects</p>
            
            <!-- Contractors Services Grid -->
            <div class="menu-grid">
                <div class="menu-item contractor-service" data-service="projects">
                    <div class="menu-icon"><i class="fas fa-project-diagram"></i></div>
                    <h3 class="menu-title">Projects</h3>
                    <p class="menu-description">Completed • Ongoing • Estimated</p>
                </div>
                <div class="menu-item contractor-service" data-service="quick-quote">
                    <div class="menu-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                    <h3 class="menu-title">Quick quote</h3>
                    <p class="menu-description">Rapid site visit, photos/videos, measurements, PDF</p>
                </div>
                <div class="menu-item contractor-service" data-service="gallery">
                    <div class="menu-icon"><i class="fas fa-images"></i></div>
                    <h3 class="menu-title">Gallery</h3>
                    <p class="menu-description">Manage project photos and videos</p>
                </div>
                <div class="menu-item contractor-service" data-service="accounting">
                    <div class="menu-icon"><i class="fas fa-calculator"></i></div>
                    <h3 class="menu-title">Accounting</h3>
                    <p class="menu-description">Costs, incomes, financial reports</p>
                </div>
            </div>
            
            <h2 class="page-subtitle" style="margin-top:1rem;">Shortcuts</h2>
            <div id="modulesContractors" class="menu-grid"></div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2024 Construction Management System</p>
    </footer>

    <!-- Auth Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-content">
            <div class="auth-header">
                <h2 id="authTitle">Sign in</h2>
                <button class="close-btn" id="closeAuth">&times;</button>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" class="auth-form">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="auth-submit">Sign in</button>
                
                <!-- Google Sign-In Button -->
                <div class="social-login">
                    <div class="divider">
                        <span>or</span>
                    </div>
                    <button type="button" id="googleSignIn" class="google-signin-btn">
                        <i class="fab fa-google"></i>
                        <span>Sign in with Google</span>
                    </button>
                </div>
                
                <p class="auth-switch">
                    Don't have an account?
                    <a href="#" id="showRegister">Register</a>
                </p>
            </form>
            
            <!-- Register Form -->
            <form id="registerForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label for="registerName">Full name:</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email:</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label for="registerPhone">Phone:</label>
                    <input type="tel" id="registerPhone" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password:</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <button type="submit" class="auth-submit">Register</button>
                
                <!-- Google Sign-In Button -->
                <div class="social-login">
                    <div class="divider">
                        <span>or</span>
                    </div>
                    <button type="button" id="googleSignInRegister" class="google-signin-btn">
                        <i class="fab fa-google"></i>
                        <span>Register with Google</span>
                    </button>
                </div>
                
                <p class="auth-switch">
                    Already registered? 
                    <a href="#" id="showLogin">Sign in</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Add Service Modal -->
    <div id="addServiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add new service</h2>
                <button class="close-btn" onclick="closeAddServiceModal()">&times;</button>
            </div>
            <form id="addServiceForm" class="modal-form">
                <div class="form-group">
                    <label for="serviceName">Service name:</label>
                    <input type="text" id="serviceName" required>
                </div>
                <div class="form-group">
                    <label for="serviceType">Service type:</label>
                    <select id="serviceType" required>
                        <option value="">Select</option>
                        <option value="reports">Reports</option>
                        <option value="estimates">Estimates</option>
                        <option value="projects">Projects</option>
                        <option value="finances">Finances</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="serviceDescription">Description:</label>
                    <textarea id="serviceDescription" placeholder="Enter service description"></textarea>
                </div>
                <div class="form-group">
                    <label for="serviceCost">Cost (£):</label>
                    <input type="number" id="serviceCost" min="0">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddServiceModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AI Assistant Modal -->
    <div id="aiModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>AI Assistant</h2>
                <button class="close-btn" id="aiCloseBtn">&times;</button>
            </div>
            <div class="form-group" style="margin-top:8px;">
                <label>OpenAI API Key</label>
                <div style="display:flex;gap:.5rem;">
                    <input type="password" id="openaiKey" placeholder="sk-..." style="flex:1;">
                     <button id="saveKeyBtn" class="btn-primary">Connect</button>
                     <button id="clearKeyBtn" class="btn-secondary">Clear</button>
                </div>
                 <small id="keyStatus" style="display:block;margin-top:.25rem;color:#6c757d;">The key is stored only on your device</small>
            </div>

            <div class="tabs" style="display:flex;gap:.5rem;margin:1rem 0;">
                <button class="btn-secondary ai-tab" data-tab="chat">Chat</button>
                <button class="btn-secondary ai-tab" data-tab="voice">Voice → text</button>
                <button class="btn-secondary ai-tab" data-tab="image">Image analysis</button>
            </div>

            <div id="aiChatTab" class="ai-tab-pane">
                <div class="form-group">
                    <label>Model</label>
                    <select id="chatModel">
                        <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
                        <option value="gpt-4o">gpt-4o</option>
                    </select>
                </div>
                <form id="chatForm" class="modal-form">
                    <textarea id="chatInput" placeholder="Enter your question..." required></textarea>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Send</button>
                    </div>
                </form>
                <div id="chatOutput" class="message" style="margin-top:8px;position:static;"></div>
            </div>

            <div id="aiVoiceTab" class="ai-tab-pane" style="display:none;">
                <div class="form-group">
                    <label>Speech to text</label>
                    <div style="display:flex;gap:.5rem;">
                        <button id="recBtn" class="btn-primary"><i class="fas fa-microphone"></i> Record</button>
                        <select id="sttModel">
                            <option value="whisper-1">whisper-1</option>
                            <option value="gpt-4o-transcribe">gpt-4o-transcribe</option>
                        </select>
                    </div>
                </div>
                <div id="sttOutput" class="message" style="margin-top:8px;position:static;"></div>
            </div>

            <div id="aiImageTab" class="ai-tab-pane" style="display:none;">
                <div class="form-group">
                    <label>Image</label>
                    <input type="file" id="imageFile" accept="image/*">
                </div>
                <div class="form-group">
                    <label>Prompt</label>
                    <input type="text" id="imagePrompt" placeholder="e.g., wall crack, damage estimate...">
                </div>
                <div class="form-actions">
                    <button id="analyzeBtn" class="btn-primary">Analyze</button>
                </div>
                <div id="imageOutput" class="message" style="margin-top:8px;position:static;"></div>
            </div>
        </div>
    </div>

    <!-- Quick Quote Wizard Modal -->
    <div id="quoteModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Site visit & quotation</h2>
                <button class="close-btn" id="quoteCloseBtn">&times;</button>
            </div>
            <div class="wizard-steps" style="display:flex;gap:.5rem;margin:.5rem 0;">
                <span class="step-badge" data-step="1">1</span>
                <span class="step-badge" data-step="2">2</span>
                <span class="step-badge" data-step="3">3</span>
                <span class="step-badge" data-step="4">4</span>
                <span class="step-badge" data-step="5">5</span>
                <span class="step-badge" data-step="6">6</span>
            </div>
            <div id="step1" class="wizard-step">
                <div class="form-group"><label>Source</label>
                    <select id="leadSource">
                        <option>MyBuilder</option><option>Checkatrade</option><option>Bark</option><option>MyJobQuote</option><option>Other</option>
                    </select>
                </div>
                <div class="form-group"><label>Quote/Ref code</label><input id="leadCode" placeholder="e.g., MB-12345"></div>
                <div class="form-group"><label>Client</label><input id="clientName"></div>
                <div class="form-group"><label>Phone</label><input id="clientPhone" inputmode="tel"></div>
                <div class="form-group"><label>Address</label><input id="siteAddress"></div>
                <div class="form-group"><label>Initial brief</label><textarea id="brief"></textarea></div>
            </div>
            <div id="step2" class="wizard-step" style="display:none;">
                <div class="form-group"><label>Photos (rear camera)</label>
                    <input type="file" id="photos" accept="image/*" capture="environment" multiple>
                </div>
                <div class="form-group"><label>Video</label>
                    <input type="file" id="videos" accept="video/*" capture="environment" multiple>
                </div>
                <div class="form-group"><label>Drawings (DWG/JPG/PNG/PDF)</label>
                    <input type="file" id="drawings" accept=".dwg,.pdf,image/*" multiple>
                </div>
                <div id="mediaPreview" class="message" style="margin-top:.5rem;position:static;"></div>
                <div class="form-group"><label>Trades (multi-select)</label>
                    <select id="tradeMulti" multiple style="min-height:96px;"></select>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="showRates"> Show reference rates (Checkatrade)</label>
                    <div id="ratesTable" style="display:none;margin-top:.5rem;overflow:auto;"></div>
                </div>
            </div>
            <div id="step3" class="wizard-step" style="display:none;">
                <div id="measureList"></div>
                <button id="addMeasure" class="btn-secondary">Add space/room</button>
                <div class="message" style="margin-top:.5rem;position:static;">Area and volume are calculated automatically.</div>
            </div>
            <div id="step4" class="wizard-step" style="display:none;">
                <div class="form-group"><label>Work checklist</label>
                    <div id="checklistContainer"></div>
                </div>
            </div>
            <div id="step5" class="wizard-step" style="display:none;">
                <div class="form-group" style="display:flex;gap:.5rem;align-items:center;">
                    <button id="aiSuggestBtn" class="btn-primary"><i class="fas fa-magic"></i> AI suggest</button>
                    <small>If no API key, internal catalogue is used.</small>
                </div>
                <div id="boqTable"></div>
                    <div class="form-group" style="text-align:left">
                    <strong>Grand total: </strong>£<span id="grandTotal">0</span>
                </div>
            </div>
            <div id="step6" class="wizard-step" style="display:none;">
                <div class="form-group"><label>Terms and notes</label><textarea id="terms" placeholder="Payment terms, scope of work, quote validity..."></textarea></div>
                <div class="form-group" style="display:flex;gap:.5rem;align-items:center;">
                    <label for="langSelect" style="margin:0;">PDF language:</label>
                    <select id="langSelect" style="width:auto;">
                        <option value="fa">Persian</option>
                        <option value="en">English</option>
                    </select>
                    <button id="activateProjectBtn" class="btn-secondary">Activate project</button>
                </div>
                <button id="generatePdf" class="btn-primary"><i class="fas fa-file-pdf"></i> Generate PDF</button>
                <div id="pdfStatus" class="message" style="margin-top:.5rem;position:static;"></div>
            </div>
            <div class="form-actions" style="justify-content:space-between;margin-top:1rem;">
                <button id="prevStep" class="btn-secondary">Previous</button>
                <button id="nextStep" class="btn-primary">Next</button>
            </div>
        </div>
    </div>

    <!-- Vendor and feature scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/config.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="../js/modules.js"></script>
    <script src="../js/features.js"></script>
    <script src="../js/contractors.js"></script>
    <script src="../js/labour-rates.js"></script>
    <script src="../js/ai-addon.js"></script>
    <script src="../js/catalog.js"></script>
    <script src="../js/quote-wizard.js"></script>
    <script src="../js/site-map.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        if (window.Modules) {
          Modules.renderShortcuts('#modulesContractors', [
            { id:'accounting', title:'Accounting (Contractors)', icon:'fas fa-calculator', target:'contractors' },
            { id:'accounting', title:'Accounting - Projects (Finished)', icon:'fas fa-file-invoice-dollar', target:'projects:finished' },
            { id:'accounting', title:'Accounting - Projects (Ongoing)', icon:'fas fa-briefcase', target:'projects:ongoing' },
            { id:'accounting', title:'Accounting - Projects (Estimate)', icon:'fas fa-money-check-alt', target:'projects:estimate' }
          ]);
        }
        if (window.Features) Features.init();
        // Navigation for 4 tiles
        document.querySelector('.contractor-service[data-service="projects"]')?.addEventListener('click', ()=>{ window.location.href = 'projects.html'; });
        document.querySelector('.contractor-service[data-service="gallery"]')?.addEventListener('click', ()=>{ window.location.href = 'gallery.html'; });
        document.querySelector('.contractor-service[data-service="accounting"]')?.addEventListener('click', ()=>{ window.location.href = 'accounting.html?ctx=contractors'; });
      });
    </script>
</body>
</html>
